---
title: "Fairness/causation: Stop and Frisk dataset"
output: github_document
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(reshape2)
library(e1071)
library(glmnet)
source("functions.R")
```

## Data

From the [NYC Stop and Frisk dataset](http://www.nyclu.org/content/stop-and-frisk-data) @stop:2014. 

```{r, cache=TRUE}
data <- read.csv("2014_stop_and_frisk.csv", strip.white = TRUE, header = TRUE)
# only use part of the data because of NAs, then remove NAs
data = data[,c("year","frisked","age","race","timestop","build","eyecolor","haircolr","arstmade")]
#data = data.frame(data$year,data$frisked,data$age,data$race,data$timestop,data$build,data$eyecolor,data$haircolr)
data = data[complete.cases(data),]
output <- data
t(head(data))[,1:3]
```

## Imbalances in the data

Average outcomes by race.

```{r}
data %>% group_by(race) %>% summarise(count = n(), arstmade = mean(arstmade))
```

Race variables:

1 - black

2 - black Hispanic

3 - white Hispanic

4 - white

5 - Asian/Pacific Islander

6 - Am. Indian/Native


Distribution plot.

```{r}
ggplot(data, aes(arstmade, linetype = factor(race))) + geom_density() + theme_bw()
```

### Linear regression

Predicted averages coincide with data averages.

```{r, cache=TRUE}
model.lm <- lm(arstmade ~ year+frisked+race+timestop+build+eyecolor+haircolr, data)
output$predlm <- predict(model.lm)
```

### Blinded to unfair covariates

Outcomes are only slightly less biased.

```{r, cache=TRUE}
lm.blind <- fairpred_blind(data, "arstmade", "race", method = "lm")
output$lmblind <- predict(lm.blind)
```

### Two-stage procedure

Greedily enforces fairness first, then builds predictions.

```{r, cache=TRUE}
lm.lm <- fairpred_2s(data, "arstmade", "race", method1 = "lm", method2 = "lm")
output$lm_lm <- predict(lm.lm)
```

### Comparing imbalance

Subgroup means.

```{r}
output %>% group_by(race) %>%
  summarise_if(.predicate = function(v) is.numeric(v), .funs = funs("mean"))
```

Distribution plots.
# Error

### Comparing (in-sample) mean-squared prediction error

```{r}
outputMSE <- data.frame((output$arstmade - output[,4:ncol(output)])^2)
outputMSE$const <- output$arstmade^2
outputMSE %>% summarise_all("mean")
```
